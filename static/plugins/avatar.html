<div id="chat_avatars" style="width:1px;height:1px;position:absolute;left:-1000px;"></div>
<script>

var base64regxp = RegExp('^([A-Za-z0-9+/]{4})*([A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{2}==)?$');

function getRealnameInfo(realname) {
	if(base64regxp.test(realname)) {
			var data = atob(realname).split("|");
			if (data && data.length >= 4) {
				//"#|male|42|#"
		        var avatar = data[0] === '#' ? null : data[0];
		        var gender = data[1] === '#' ? null : data[1];
		        var age = data[2] === '#' ? null : data[2];
						var photo = data[3] === '#' ? null : "https://images.chateagratis.net" + data[3];

				return {avatar, gender, age, photo};
			}
	}
	return {};
}

var scratch = document.querySelector('#chat_avatars');

function addPhoto(avatarUrl, nick, network) {
	var img = document.createElement('img');
	img.src = avatarUrl;

	// irccloud replies with a 404 if an avatar doesn't exist, so this onload callback
	// will only be called for successful avatars
	img.onload = function() {
			kiwi.state.addUser(network.id, {nick: nick, avatar: {
					small: avatarUrl,
			}});

			scratch.removeChild(img);
	};

	img.onerror = function() {
			scratch.removeChild(img);
	};

	scratch.appendChild(img);
}

kiwi.on('irc.raw.354', function(command, event, network) {
    if(event.params.length < 11) return;

    var m = getRealnameInfo(event.params[10]).photo;
    if (m) {
			addPhoto(m, event.params[5], network);
    }
});

kiwi.on('irc.join', function(event, network) {
		var m = getRealnameInfo(event.gecos).photo;
		if (m) {
			addPhoto(m, event.nick ,network);
		}
});
</script>
